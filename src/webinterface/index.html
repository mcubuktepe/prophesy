<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Prophesy UI</title>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    <style>

    </style>
    <link href="buttons.css" rel="stylesheet" type="text/css">
    <link href="tabs.css" rel="stylesheet" type="text/css">
    <link href="stylesheet.css" rel="stylesheet" type="text/css">
    <script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
    <script language="javascript" type="text/javascript" src="flot/jquery.flot.js"></script>
    <script type="text/javascript" language="javascript" src="flot/jquery.flot.symbol.js"></script>
    <script language="javascript" type="text/javascript" src="flot/jquery.flot.crosshair.js"></script>
    <script language="javascript" type="text/javascript" src="webcegar.js"></script>
    <script language="javascript">
var threshold = "0.5";
var samples = [];
var safe_constraints = [];
var bad_constraints = [];

var newSamples = [];
var newConstraint = [];
var newConstraintComplete = true;

var PlotMode = Object.freeze({SAMPLE: 1, CONSTRAINT: 2});
var currentPlotMode = PlotMode.SAMPLE;

var options = {
        axisLabels: {
            show: true
        },
        crosshair: {
                mode: "xy"
        },
        xaxis: {
            min: 0,
            max: 1,
            tickSize: 0.1,
            tickDecimals: 1,
            axisLabel: "parameter1",
            axisLabelUseCanvas: true,
            axisLabelFontSizePixels: 12,
            axisLabelFontFamily: "Verdana, Arial, Helvetica, Tahoma, sans-serif",
            axisLabelPadding: 5
        },
        yaxis: {
            min: 0,
            max: 1,
            tickSize: 0.1,
            tickDecimals: 1,
            axisLabel: "parameter2",
            axisLabelUseCanvas: true,
            axisLabelFontSizePixels: 12,
            axisLabelFontFamily: "Verdana, Arial, Helvetica, Tahoma, sans-serif",
            axisLabelPadding: 5
        },
        series: {
            points: {
                radius: 3,
                show: true,
                fill: true
            }
        },
        grid: {
                hoverable: true,
                clickable: true
        },
        legend: {
            labelBoxBorderColor: "black",
            position: "right"
        }};

var isBusy = false;
function setBusy(busy) {
    if (busy && isBusy) {
        alert("Operation in progress");
        throw "Operation in progress";
    }
    if (busy) {
        $("#busy-indicator").show();
        $("#header").addClass("busy");
    } else {
        $("#busy-indicator").hide();
        $("#header").removeClass("busy");
    }
    isBusy = busy;
}

function clearError() {
    $("#errorbox").removeClass("shown");
}

function checkError(result) {
    if (result !== null) {
        $("#error-message").text(result.reason);
    } else {
        $("#error-message").text("Unspecified error");
    }
    $("#errorbox").addClass("shown");
}

function doJSON(url, onSuccess = function(result) {}, onFail = function() {}) {
    doAjax({
        dataType: "json",
        url: url,
    }, onSuccess, onFail);
}

function doAjax(ajax, onSuccess = function(result) {}, onFail = function() {}) {
    failHandler = function(jqXHR) {
        try {
            return $.parseJSON(jqXHR.responseText);
        } catch(err) {
            return null;
        }
    }

    try {
        setBusy(true);
    } catch(err) {
        // Don't try and do two things at the same time,
        // the server serializes session access
        return null;
    }

    clearError();
    $.ajax(ajax)
    .done(function(data) {
        setBusy(false);
        if (data.status == "ok") {
            onSuccess(data);
        } else {
            checkError(data);
        }
    })
    .fail(function(jqXHR) {
        setBusy(false);
        checkError(failHandler(jqXHR));
        onFail();
    })
    .always(function() {
        setBusy(false);
    });
}

function plotSamples() {
    safeData = [];
    badData = [];
    for (var key in samples) {
        var sample = samples[key];
        pt = [sample[0], sample[1]];
        if (sample[2] < threshold) {
            safeData.push(pt)
        } else {
            badData.push(pt)
        }
    };
    fillNewConstraint = false;
    if (newConstraint.length > 2) {
        var last = newConstraint.length - 1;
        if (newConstraint[0][0] == newConstraint[last][0] && newConstraint[0][1] == newConstraint[last][1]) {
            fillNewConstraint = true;
        }
    }

    plotpoints = [{label: "new", data: [], points: { symbol: "circle", fillcolor: "orange"}, color: "orange"},
                  {label: "< " + threshold, data: safeData, points: { symbol: "cross", fillColor: "#aa2323" }, color: "#aa2323"}, 
                  {label: ">=" + threshold, data: badData, points: { symbol: "square", fillColor: "#50B432" }, color: "#50B432"},
                  {label: "new constr", data: newConstraint, points: { symbol: "circle", fillcolor: "black"}, lines: { show: true, fill: fillNewConstraint}, color: "black"},
                  {label: "safe constr", data: [], points: { symbol: "circle", fillcolor: "green"}, lines: { show: true, fill: true}, color: "green"},
                  {label: "bad constr", data: [], points: { symbol: "circle", fillcolor: "red"}, lines: { show: true, fill: true}, color: "red"}];
    for (var key in safe_constraints) {
        plotpoints.push({data: safe_constraints[key], points: { symbol: "circle", fillcolor: "green"}, lines: { show: true, fill: true}, color: "green"});
    }
    for (var key in bad_constraints) {
        plotpoints.push({data: bad_constraints[key], points: { symbol: "circle", fillcolor: "red"}, lines: { show: true, fill: true}, color: "red"});
    }
    plotpoints.push({data: newSamples, points: { symbol: "circle", fillcolor: "orange"}, color: "orange"});
    $.plot("#placeholder", plotpoints, options);
}

function readSamples(new_samples) {
    samples = [];
    for (var key in new_samples) {
        var sample = new_samples[key];
        samples.push([sample.coordinate[0], sample.coordinate[1], sample.value])
    };
}

function writeSamples(samples) {
    data = [];
    for (var key in samples) {
        var sample = samples[key];
        data.push({'coordinate':sample, 'value':-1.0});
    };
    return data;
}

$(document).ready(function() {
    // Install handler for tabs
    $('.tab-links a').on('click', function(e)  {
        var currentAttrValue = jQuery(this).attr('href');
        jQuery(currentAttrValue).show().siblings().hide();
        jQuery(this).parent('li').addClass('active').siblings().removeClass('active');
        e.preventDefault();
    });
  
    $("#placeholder").bind("plothover", function (event, pos, item) {
        var str = "(" + pos.x.toFixed(2) + ", " + pos.y.toFixed(2) + ")";
        $("#mousePos").text(str);
    });

    $("#placeholder").bind("plotclick", function (event, pos, item) {
        var pt = [pos.x.toFixed(2), pos.y.toFixed(2)];

        if (currentPlotMode == PlotMode.SAMPLE) {
            newSamples.push(pt);
            plotSamples();
        } else if (currentPlotMode == PlotMode.CONSTRAINT) {
            var n = newConstraint.length;
            // No loop possible yet
            if(n < 2) {
                newConstraint.push(pt);
                plotSamples();
                return;
            }

            // Check if a previous contraint has to be cleared
            if (newConstraint[0][0] == newConstraint[n-1][0] && newConstraint[0][1] == newConstraint[n-1][1]) {
                // Constraint was complete already, clear it and make new
                newConstraint = [pt];
                plotSamples();
                return;
            }

            // Check if the last point was already in the constraint set, if so it is complete.
            for(i = 0; i < n; i++)
            {
                if(newConstraint[i][0] == pt[0] && newConstraint[i][1] == pt[1])
                {
                    newConstraint = newConstraint.slice(i);
                    newConstraint.push(pt);
                    plotSamples();
                    return;
                }
            }

            newConstraint.push(pt);
            plotSamples();
        }
    });    

    $("#addSamples").change(function(e) {
        if ($(this).prop('checked')) {
            $("#addConstraint").prop('checked', false);
            currentPlotMode = PlotMode.SAMPLE;
        }
    });
    $("#addConstraint").change(function(e) {
        if ($(this).prop('checked')) {
            $("#addSamples").prop('checked', false);
            currentPlotMode = PlotMode.CONSTRAINT;
        }
    });

    // Handler for upload of PRISM
    $('#form-prism').submit(function(event){
        event.preventDefault();

        var formData = new FormData($(this)[0]);
        doAjax({
            url: '../uploadPrism',
            type: 'POST',
            // Form data
            data: formData,
            //Options to tell jQuery not to process data or worry about content-type.
            cache: false,
            contentType: false,
            processData: false
        }, function() {
            getCurrentResult();
            listAvailableResults();
        });
    });

    // Handler for upload of result
    $('#form-result').submit(function(event){
        event.preventDefault();

        var formData = new FormData($(this)[0]);
        doAjax({
            url: '../uploadResult',
            type: 'POST',
            // Form data
            data: formData,
            //Options to tell jQuery not to process data or worry about content-type.
            cache: false,
            contentType: false,
            processData: false
        }, function() {
            getCurrentResult();
            listAvailableResults();
        });
    });

    // Handler for changing active result
    $('#form-select').submit(function(event) {
        event.preventDefault();

        result_name = $("#result-files").val();
        setCurrentResult(result_name);
    });

    $( "#form-samples-manual" ).submit(function( event ) {
        event.preventDefault();

        doAjax({
            url: "../addSamples",
            type: 'POST',
            // JSON data
            data: JSON.stringify(newSamples),
            dataType: 'json',
            //Options to tell jQuery not to process data or worry about content-type.
            cache: false,
            contentType: 'application/json',
            processData: false
        },function(result) {
                //Clear samples
                samples = [];
                newSamples = [];
                readSamples(result.data);
                plotSamples();
        });
    });
    
    $( "#form-samples-auto" ).submit(function( event ) {
        event.preventDefault();

        var formData = new FormData($(this)[0]);
        doAjax({
            url: '../generateSamples',
            type: 'POST',
            // Form data
            data: formData,
            //Options to tell jQuery not to process data or worry about content-type.
            cache: false,
            contentType: false,
            processData: false
        }, function(result) {
            //Clear samples
            samples = [];
            newSamples = [];
            readSamples(result.data);
            plotSamples();
        });
    });
    
    $( "#form-constraints-manual" ).submit(function( event ) {
        event.preventDefault();
        
        var formData = new FormData($(this)[0]);
        formData.append('coordinates', JSON.stringify(newConstraint));
        doAjax({
            url: '../checkConstraint',
            type: 'POST',
            // Form data
            data: formData,
            //Options to tell jQuery not to process data or worry about content-type.
            cache: false,
            contentType: false,
            processData: false
        },function(result) {
            for (var key in result.data.sat) {
                var sample = result.data.sat[key];
                samples.push([sample.coordinate[0], sample.coordinate[1], sample.value])
            };
            var status = result.data.result
            for (var key in result.data.unsat) {
                var constraint = result.data.unsat[key];
                if (constraint[1]) {
                    safe_constraints.push(constraint[0]);
                } else {
                    bad_constraints.push(constraint[0]);
                }
            };
            newConstraint = [];
            plotSamples();
        });
    });
    
    $( "#form-constraints-auto" ).submit(function( event ) {
        event.preventDefault();
        
        var formData = new FormData($(this)[0]);
        doAjax({
            url: '../generateConstraints',
            type: 'POST',
            // Form data
            data: formData,
            //Options to tell jQuery not to process data or worry about content-type.
            cache: false,
            contentType: false,
            processData: false
        }, function(result) {
            for (var key in result.data.sat) {
                var sample = result.data.sat[key];
                samples.push([sample.coordinate[0], sample.coordinate[1], sample.value])
            };
            var status = result.data.result
            for (var key in result.data.unsat) {
                var constraint = result.data.unsat[key];
                if (constraint[1]) {
                    safe_constraints.push(constraint[0]);
                } else {
                    bad_constraints.push(constraint[0]);
                }
            }
            plotSamples();
        });
    });
    
    $("#clear-constraint").click(function(event) {
        newConstraint = [];
        plotSamples();
    });
    
    // Handler for change of settings
    $("#thresholdSlider").on('change', function() {
        threshold = $('#thresholdSlider').val()/1000;
        $("#thresvalue").text(threshold);
        setThreshold(threshold);
        plotSamples();
    });
    
    $("#samplers").on('change', function() {
        setEnv();
    });
    $("#satsolvers").on('change', function() {
        setEnv();
    });
    
    /////////////////////////
    // Things to do initially
    /////////////////////////
    
    // Show the empty graph immediately
    plotSamples();
    
    // Load initial settings
    // Manually set busy to false, server will serialize output
    listEnv();
    isBusy = false;
    listAvailableResults();
    isBusy = false;
    getThreshold();
    isBusy = false;
    getSamples();
    isBusy = false;
});


</script>
</head>
 
<body>
<div id="header"><h1>Prophesy UI</h1><span id="busy-indicator">Working...</span></div>
<div id="errorbox"><span id="error-title">Error occured:</span> <span id="error-message">Error value not set</span></div>

<div id="plotsurround">
    <div id="placeholder"></div>
    <span id="mousePos">(0.00, 0.00)</span>
</div>

<div id="controlpanel">
    <div id="input">
        <h2>Input</h2>
        <ul class="tab-links">
            <li class="active" ><a href="#tab-prism">Upload Prism</a></li>
            <li><a href="#tab-upload">Upload result</a></li>
            <li><a href="#tab-select">Select result</a></li>
        </ul>
        <div class="tab-contents">
            <div id="tab-prism" class="tab active cp">
                <form id="form-prism">
                    <span>Path to prism file:</span><input type="file" name="file" />
                    <br>
                    <span>Path to PCTL file:</span><input type="file" name="pctl-file" />
                    <br>
                    <span>Run with:</span>
                    <select id="mctools" name="mctool">
                        <option>No tool available</option>
                    </select>
                    <br/>
                    <button id="upload-prism" type="submit" class="upload">Upload</button>
                </form>
            </div>
            
            <div id="tab-upload"  class="tab cp">
                <form id="form-result">
                    <span>Path to result file:</span><input type="file" name="file"/>
                    <br>
                    <select name="result-type">
                        <option value="pstorm" selected="selected">pstorm</option>
                        <option value="param">param</option>
                    </select>
                    <br/>
                    <button id="upload-result" type="submit" class="upload">Upload</button>
                </form>
            </div>
            
            <div id="tab-select" class="tab cp">
                <form id="form-select">
                    <select id="result-files">
                    </select>
                    <button id="select-result" type="submit" class="positive">Load</button>
                </form>
            </div>
        </div>
    </div> <!-- Input -->
    
    <div id="samples">
        <h2>Sampling</h2>
        <ul class="tab-links">
            <li class="active" ><a href="#tab-manual">Manual Sampling</a></li>
            <li><a href="#tab-auto">Auto Sampling</a></li>
        </ul>
        <div class="tab-contents">
            <div id="tab-manual" class="tab active cp">
                <form id="form-samples-manual">
                    <label><input id="addSamples" type="radio" checked="checked"/> Add samples by mouse clicks</label>
                    <br>
                    <button id="submit-samples" type="submit" class="positive">Check New</button>
                </form>
            </div>
            <div id="tab-auto" class="tab cp">
                <form id="form-samples-auto">
                    <label>Sampling number: <input name="sampling" type="number" min="2" max="50" value="2" size="1"/></label>
                    <br/>
                    <label>Number of iterations: <input name="iterations" type="number" min="0" max="10" value="2"/></label>
                    <br>
                    <select name="generator">
                        <option value="linear" selected="selected">Linear interpolation</option>
                        <option value="delaunay">Delaunay triangulation</option>
                    </select>
                    <br>
                    <button id="generate-samples" type="submit">Go</button>
                </form>
            </div>
        </div>
    </div> <!-- Samples -->
    
    
    <div id="constraints">
        <h2>Constraints</h2>
        <ul class="tab-links">
            <li class="active" ><a href="#tab-constr-manual">Manual Constraints</a></li>
            <li><a href="#tab-constr-auto">Auto Constraints</a></li>
        </ul>
        <div class="tab-contents">
            <div id="tab-constr-manual" class="tab active cp">
                <form id="form-constraints-manual">
                    <label><input id="addConstraint" type="radio"/> Add constraints by mouse clicks</label>
                    <br>
                    <label><input name="constr-mode" type="radio" value="safe" checked="checked"/> Check for safe</label>
                    <label><input name="constr-mode" id="radio-bad" type="radio" value="bad"/> Check for bad</label>
                    <br>
                    <button id="manualConstraints" type="submit" class="positive">Check New</button>
                    <button id="clear-constraint" type="button" class="negative">Clear current</button>
                </form>
            </div>
            <div id="tab-constr-auto" class="tab cp">
                <form id="form-constraints-auto">
                    <select name="generator">
                        <option selected="selected" value="planess">Planes</option>
                        <option value="rectangles">Growing rectangles</option>
                        <option value="quads">Quadrants</option>
                    </select>
                    <button id="autoConstraints" type="submit" class="positive">Generate</button>
                </form>
            </div>
        </div>
    </div> <!-- Constraints -->
    
    <div id="settings">
        <h2>Settings</h2>
        <span>Threshold:</span>
        <input type="range" min="0" max="1000" value="500" id="thresholdSlider" /><span id="thresvalue">0.5</span>
        <br>
        <span>Sampler:</span>
        <select id="samplers">
            <option>No sampler available</option>
        </select>
        <br>
        <span>SMT Solver:</span>
        <select id="satsolvers">
            <option>No solver available</option>
        </select>
    </div>
</div> <!-- Control panel -->

<div id="infopanel">
    <h2>Info</h2>
    <h3>Rational Function</h3>
    <div id="info_ratfunc">Not loaded</div>
</div>

</body>
  
</html>