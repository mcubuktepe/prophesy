<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Prophesy UI</title>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    <style>

    </style>
    <link href="stylesheet.css" rel="stylesheet" type="text/css">
    <script language="javascript" type="text/javascript" src="constraints.js"></script>
    <script language="javascript" type="text/javascript" src="jquery.js"></script>
    <script language="javascript" type="text/javascript" src="flot/jquery.flot.js"></script>
    <script type="text/javascript" language="javascript" src="flot/jquery.flot.symbol.js"></script>
    <script language="javascript" type="text/javascript" src="flot/jquery.flot.crosshair.js"></script>
    <script language="javascript" type="text/javascript" src="webcegar.js"></script>
    <script language="javascript">
    
    
var d1 = [[0,1],[1,2],[3,8],[5,4],[2,10],[1.2,9],[9,2],[46,41],[22,14],[20,12],[20,25],[7,5],[18,11],[31,20]];
var d2 = [[50,40],[24,36],[20,42],[33,41],[51,39],[11,28],[32,16],[38,40],[35,22],[41,30],[21,18]];
var threshold = "0.5";

var safeData = [];
var badData = [];
var newSamples = [];
var newConstraint = [];

var options = {
        axisLabels: {
            show: true
        },
        crosshair: {
                mode: "xy"
        },
        xaxis: {
            min: 0,
            max: 1,
            tickSize: 0.1,
            tickDecimals: 1,
            axisLabel: "parameter1",
            axisLabelUseCanvas: true,
            axisLabelFontSizePixels: 12,
            axisLabelFontFamily: "Verdana, Arial, Helvetica, Tahoma, sans-serif",
            axisLabelPadding: 5
        },
        yaxis: {
            min: 0,
            max: 1,
            tickSize: 0.1,
            tickDecimals: 1,
            axisLabel: "parameter2",
            axisLabelUseCanvas: true,
            axisLabelFontSizePixels: 12,
            axisLabelFontFamily: "Verdana, Arial, Helvetica, Tahoma, sans-serif",
            axisLabelPadding: 5
        },
        series: {
            points: {
                radius: 3,
                show: true,
                fill: true
            }
        },
        grid: {
                hoverable: true,
                clickable: true
        },
        legend: {
            labelBoxBorderColor: "black",
            position: "right"
        }};

function plotSamples(newConstraintFixed = false) {
    plotpoints = [{label: "< " + threshold, data: safeData, points: { symbol: "cross", fillColor: "#aa2323" }, color: "#aa2323"}, 
                  {label: "> " + threshold, data: badData, points: { symbol: "square", fillColor: "#50B432" }, color: "#50B432"},
                  {label: "new", data: newSamples, points: { symbol: "circle", fillcolor: "orange"}, color: "orange"},
                  {label: "new constr", data: newConstraint, points: { symbol: "circle", fillcolor: "black"}, lines: { show: true, fill: newConstraintFixed}, color: "black"}];
    $.plot("#placeholder", plotpoints, options);
}
        
function drawSamples() {
    function onDataReceived(series) {
        safeData = [];
        badData = [];
        $.each(series, function() {
            if(this.value < threshold)
            {
                safeData.push(this.coordinates);
            }
            else
            {
                badData.push(this.coordinates);
            }
        });
        plotSamples();
    };

    $.ajax({
        url: "../getSamples/",
        type: "GET",
        dataType: "json",
        success: onDataReceived
    });
}

$(document).ready(function() {
    // Install handler for tabs
    $('.tab-links a').on('click', function(e)  {
        var currentAttrValue = jQuery(this).attr('href');
        jQuery(currentAttrValue).show().siblings().hide();
        jQuery(this).parent('li').addClass('active').siblings().removeClass('active');
        e.preventDefault();
    });

    $( "#drawSamples" ).click(drawSamples());

    $( "#manualSamples" ).click(function() {
        function onDataReceived(series) {
            drawSamples();
            newSamples = [];
        };

        $.ajax({
            url: "../manualCheckSamples/",
            type: "POST",
            contentType: "application/json;charset=utf-8",
            data: JSON.stringify(newSamples),
            dataType: "json",
            success: onDataReceived
        });
    });
  
    $( "#fNewSamples" ).submit(function( event ) {
        event.preventDefault();
        iterations = $("#iterations").val();
        sampling = $("#sampling").val();
        function onDataReceived(func) {
            drawSamples();
        }
        $.ajax({
                    url: "/calculateSamples/" + iterations + "/" + sampling,
                    type: "GET",
                    dataType: "json",
                    success: onDataReceived,
                    fail: function(bla) {
                        alert(bla);
                    }
        });
    });
    $("#addSamples").change(function() {
        if($("#addSamples:checked").length == 0) {
            newSamples = [];
            plotSamples();
        } else {
            $("#addConstraint").attr("checked", false);
        }
    });
  
    $("#placeholder").bind("plothover", function (event, pos, item) {

        var str = "(" + pos.x.toFixed(2) + ", " + pos.y.toFixed(2) + ")";
        $("#mousePos").text(str);
        
//         if ($("#enableTooltip:checked").length > 0) {
//             if (item) {
//                 var x = item.datapoint[0].toFixed(2),
//                     y = item.datapoint[1].toFixed(2);
// 
//                 $("#tooltip").html(item.series.label + " of " + x + " = " + y)
//                     .css({top: item.pageY+5, left: item.pageX+5})
//                     .fadeIn(200);
//             } else {
//                 $("#tooltip").hide();
//             }
//         }
    });

    $("#placeholder").bind("plotclick", function (event, pos, item) {
        if ($("#addSamples:checked").length > 0) {
            newSamples.push([pos.x.toFixed(2), pos.y.toFixed(2)]);
            plotSamples();
//         if (item) {
//             $("#clickdata").text(" - click point " + item.dataIndex + " in " + item.series.label);
//             plot.highlight(item.series, item.datapoint);
            
        } else if ($("#addConstraint:checked").length > 0) {
            var p = [pos.x.toFixed(2), pos.y.toFixed(2)];
            var n = newConstraint.length;
            if(n < 2)
            {
                newConstraint.push([pos.x.toFixed(2), pos.y.toFixed(2)]);
                plotSamples(fullCircle);
            }
            else
            {
                var t = sideOfLine(newConstraint[n-2], newConstraint[n-1], p);
                // If it is on a line with the last points, just change line.
                if(t == 0) 
                {
                    newConstraint[n-1] = p;
                    plotSamples();
                    return;
                }
                var fullCircle = false;
                // Check if the last point was already in the constraint set.
                for(i = 0; i < n; i++)
                {
                    if(newConstraint[i][0] == pos.x.toFixed(2) && newConstraint[i][1] == pos.y.toFixed(2))
                    {
                        newConstraint = newConstraint.slice(i);
                        n = newConstraint.length;
                        fullCircle = true;
                        break;
                    }
                }
                // Check convexity.    
                if(n > 2)
                {
                    var checkbound = n - 1
                    if(fullCircle)
                    {
                        checkbound = 1
                    }
                    
                    for(i = 0; i < checkbound; i++)
                    {
                        if(t != sideOfLine(newConstraint[n-2-i], newConstraint[n-1-i], p))
                        {
                            alert("Constrainted area should be convex");
                            return;
                        }
                    }
                }
                newConstraint.push([pos.x.toFixed(2), pos.y.toFixed(2)]);
                plotSamples(fullCircle);
                
                if(fullCircle) 
                {
                    origin = [0,0];
                    for(i = 0; i < newConstraint.length - 1; i++)
                    {
                        if(newConstraint[i][1] == newConstraint[i+1][1]) 
                        {
                           
                        }
                        
                    }
                }
            }
            
        }
    });    
    
    $("#addConstraint").change(function() {
        loadResult();
        if($("#addConstraint:checked").length == 0) {
            newConstraint = [];
            plotSamples();
        } else {
            $("#addSamples").attr("checked", false);
        }
    });
    




    // Handler for upload of PRISM
    $('#upload-prism').click(function(e){
        function progressHandlingFunction(e){
            if(e.lengthComputable){
                $('#prism-progress').attr({value:e.loaded,max:e.total});
            }
        }
        var formData = new FormData($('#form-prism')[0]);
        $.ajax({
            url: '../uploadPrism',
            type: 'POST',
            xhr: function() {  // Custom XMLHttpRequest
                var myXhr = $.ajaxSettings.xhr();
                if(myXhr.upload){ // Check if upload property exists
                    myXhr.upload.addEventListener('progress',progressHandlingFunction, false); // For handling the progress of the upload
                }
                return myXhr;
            },
            //Ajax events
            success: function() {alert('done');},
            error: function() {alert('error');},
            // Form data
            data: formData,
            //Options to tell jQuery not to process data or worry about content-type.
            cache: false,
            contentType: false,
            processData: false
        });
        getCurrentResult();
        listAvailableResults();
        e.preventDefault();
    });

    // Handler for upload of result
    $('#upload-result').click(function(e){
        function progressHandlingFunction(e){
            if(e.lengthComputable){
                $('#upload-progress').attr({value:e.loaded,max:e.total});
            }
        }
        var formData = new FormData($('#form-result')[0]);
        $.ajax({
            url: '../uploadResult',
            type: 'POST',
            xhr: function() {  // Custom XMLHttpRequest
                var myXhr = $.ajaxSettings.xhr();
                if(myXhr.upload){ // Check if upload property exists
                    myXhr.upload.addEventListener('progress',progressHandlingFunction, false); // For handling the progress of the upload
                }
                return myXhr;
            },
            //Ajax events
            success: function() {alert('done');},
            error: function() {alert('error');},
            // Form data
            data: formData,
            //Options to tell jQuery not to process data or worry about content-type.
            cache: false,
            contentType: false,
            processData: false
        }).fail(function(a, b, c) {print(a);});
        getCurrentResult();
        listAvailableResults();
        e.preventDefault();
    });

    // Handler for changing active result
    $('#select-result').click(function(e) {
        result_name = $("#result-files").val();
        setCurrentResult(result_name);
        getCurrentResult();
    });
    
    // Handler for change of settings
    $("#thresholdSlider").on('change', function() {
        threshold = $('#thresholdSlider').val()/1000;
        $("#thresvalue").text(threshold);
        setThreshold(threshold);
    });
    
    // Load initial settings
    getCurrentResult();
    listAvailableResults();
    getThreshold();
    drawSamples();
});


</script>
</head>
 
<body>
<div id="header"><h1>Prophesy UI</h1></div>

<div id="plotsurround">
    <div id="placeholder"></div>
    <span id="mousePos">(0.00, 0.00)</span>
</div>

<div id="controlpanel">
    <div id="input">
        <h2>Input</h2>
        <ul class="tab-links">
            <li class="active" ><a href="#tab-prism">Upload Prism</a></li>
            <li><a href="#tab-upload">Upload result</a></li>
            <li><a href="#tab-select">Select result</a></li>
        </ul>
        <div class="tab-contents">
            <div id="tab-prism" class="tab active cp">
                <form id="form-prism">
                    <span>Path to prism file:</span><input type="file" name="file" />
                    <span>Path to PCTL file:</span><input type="file" name="pctl-file" />
                    <br>
                    <span>Run with:</span>
                    <select name="mctool">
                        <option selected="selected" value="pstorm">Prophesy</option>
                        <option value="param">param</option>
                        <!--<option>prism</option>-->
                    </select>
                    <br/>
                    <span>Upload progress:</span><progress id="prism-progress" max="100" value="0"></progress>
                    <input id="upload-prism" type="button" value="Upload" class="upload"/>
                </form>
            </div>
            
            <div id="tab-upload"  class="tab cp">
                <form id="form-result">
                    <span>Path to result file:</span><input type="file" name="file"/>
                    <br>
                    <select name="result-type">
                        <option value="pstorm" selected="selected">pstorm</option>
                        <option value="param">param</option>
                    </select>
                    <br/>
                    <span>Upload progress:</span><progress id="result-progress" max="100" value="0"></progress>
                    <input id="upload-result" type="button" value="Upload" class="upload"/>
                </form>
            </div>
            
            <div id="tab-select" class="tab cp">
                <form id="form-select">
                    <select id="result-files">
                    </select>
                    <input id="select-result" type="button" value="Load" class="upload"/>
                </form>
            </div>
        </div>
    </div> <!-- Input -->
    
    <div id="sampling">
        <h2>Sampling</h2>
        <ul class="tab-links">
            <li class="active" ><a href="#tab-manual">Manual Sampling</a></li>
            <li><a href="#tab-auto">Auto Sampling</a></li>
        </ul>
        <div class="tab-contents">
            <div id="tab-manual" class="tab active cp">
                <div id="dNewSamplesContent">
                    <form id="fManualSamples"><label><input id="addSamples" type="checkbox" checked="checked">Add samples by mouse clicks</label>
                    <button id="manualSamples" class="submit">Check New</button>
                    </form>
                </div>
            </div>
            <div id="tab-auto" class="tab cp">
                <form id="fNewSamples">
                    <span>Number of iterations:</span> <input id="iterations" type="text" value="2" /><br/>
                    <span>Sampling number:</span> <input id="sampling" type="text" value="2" />
                    <input type="submit" value="Go" class="submit" />
                </form>
            </div>
        </div>
    </div> <!-- Sampling -->
    
    
    <div id="constraints">
        <h2>Constraints</h2>
        <ul class="tab-links">
            <li class="active" ><a href="#tab-constr-manual">Manual Constraints</a></li>
            <li><a href="#tab-constr-auto">Auto Constraints</a></li>
        </ul>
        <div class="tab-contents">
            <div id="tab-constr-manual" class="tab active cp">
                <div id="dNewSamplesContent">
                    <form id="fManualConstr"><label><input id="addConstraint" type="checkbox">Add constraints by mouse clicks</label>
        <button id="manualConstraints" class="submit">Check New</button>
                    </form>
                </div>
            </div>
            <div id="tab-constr-auto" class="tab cp">
                <form id="fAutoConstr">
                    
                </form>
            </div>
        </div>
    </div> <!-- Constraints -->
    
    <div id="settings">
        <h2>Settings</h2>
        <span>Threshold:</span>
        <input type="range" min="0" max="1000" value="500" id="thresholdSlider" /><span id="thresvalue">0.50</span>
        <br>
        <span>SMT Solver:</span>
        <select id="smtsolver"><option selected="selected">SMT-RAT</option><option>Z3</option></select>
    </div>
</div> <!-- Control panel -->

<div id="infopanel">
    <h2>Info</h2>
    <h3>Rational Function</h3>
    <div id="info_ratfunc">Not loaded</div>
</div>

</body>
  
</html>