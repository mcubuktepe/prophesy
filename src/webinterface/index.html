<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Prophesy UI</title>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    <style>

    </style>
    <link href="stylesheet.css" rel="stylesheet" type="text/css">
    <script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
    <script language="javascript" type="text/javascript" src="constraints.js"></script>
    <script language="javascript" type="text/javascript" src="flot/jquery.flot.js"></script>
    <script type="text/javascript" language="javascript" src="flot/jquery.flot.symbol.js"></script>
    <script language="javascript" type="text/javascript" src="flot/jquery.flot.crosshair.js"></script>
    <script language="javascript" type="text/javascript" src="webcegar.js"></script>
    <script language="javascript">

var threshold = "0.5";
var samples = [];

var newSamples = [];
var newConstraint = [];

var PlotMode = Object.freeze({SAMPLE: 1, CONSTRAINT: 2});
var currentPlotMode = PlotMode.SAMPLE;

var options = {
        axisLabels: {
            show: true
        },
        crosshair: {
                mode: "xy"
        },
        xaxis: {
            min: 0,
            max: 1,
            tickSize: 0.1,
            tickDecimals: 1,
            axisLabel: "parameter1",
            axisLabelUseCanvas: true,
            axisLabelFontSizePixels: 12,
            axisLabelFontFamily: "Verdana, Arial, Helvetica, Tahoma, sans-serif",
            axisLabelPadding: 5
        },
        yaxis: {
            min: 0,
            max: 1,
            tickSize: 0.1,
            tickDecimals: 1,
            axisLabel: "parameter2",
            axisLabelUseCanvas: true,
            axisLabelFontSizePixels: 12,
            axisLabelFontFamily: "Verdana, Arial, Helvetica, Tahoma, sans-serif",
            axisLabelPadding: 5
        },
        series: {
            points: {
                radius: 3,
                show: true,
                fill: true
            }
        },
        grid: {
                hoverable: true,
                clickable: true
        },
        legend: {
            labelBoxBorderColor: "black",
            position: "right"
        }};

function setBusy(busy) {
    if (busy) {
        jQuery("#busy-indicator").show();
    } else {
        jQuery("#busy-indicator").hide();
    }
}
        
function plotSamples(newConstraintFixed = false) {
    safeData = [];
    badData = [];
    for (var key in samples) {
        var sample = samples[key];
        pt = [sample[0], sample[1]];
        if (sample[2] < threshold) {
            safeData.push(pt)
        } else {
            badData.push(pt)
        }
    };
    plotpoints = [{label: "< " + threshold, data: safeData, points: { symbol: "cross", fillColor: "#aa2323" }, color: "#aa2323"}, 
                  {label: "> " + threshold, data: badData, points: { symbol: "square", fillColor: "#50B432" }, color: "#50B432"},
                  {label: "new", data: newSamples, points: { symbol: "circle", fillcolor: "orange"}, color: "orange"},
                  {label: "new constr", data: newConstraint, points: { symbol: "circle", fillcolor: "black"}, lines: { show: true, fill: newConstraintFixed}, color: "black"}];
    $.plot("#placeholder", plotpoints, options);
}

function readSamples(new_samples) {
    samples = [];
    for (var key in new_samples) {
        var sample = new_samples[key];
        samples.push([sample.coordinate[0], sample.coordinate[1], sample.value])
    };
}

function writeSamples(samples) {
    data = [];
    for (var key in samples) {
        var sample = samples[key];
        data.push({'coordinate':sample, 'value':-1.0});
    };
    return data;
}

$(document).ready(function() {
    // Install handler for tabs
    $('.tab-links a').on('click', function(e)  {
        var currentAttrValue = jQuery(this).attr('href');
        jQuery(currentAttrValue).show().siblings().hide();
        jQuery(this).parent('li').addClass('active').siblings().removeClass('active');
        e.preventDefault();
    });

    $( "#form-samples-manual" ).submit(function( event ) {
        event.preventDefault();

        $.ajax("../addSamples", {
            type: 'POST',
            data: JSON.stringify(newSamples),
            dataType: 'json',
            contentType: 'application/json',
            success: function(result) {
                    if (result.status == "ok") {
                        //Clear samples
                        samples = [];
                        newSamples = [];
                        readSamples(result.data);
                        plotSamples();
                    }
                },
            processData: false
            });        
    });
    
    $( "#form-samples-auto" ).submit(function( event ) {
        event.preventDefault();

        iterations = $("#iterations").val();
        sampling = $("#sampling").val();
        $.getJSON("../generateSamples/" + iterations + "/" + sampling, function(result) {
            if (result.status == "ok") {
                //Clear samples
                samples = [];
                newSamples = [];
                readSamples(result.data);
                plotSamples();
            }
        });
    });
  
    $("#placeholder").bind("plothover", function (event, pos, item) {

        var str = "(" + pos.x.toFixed(2) + ", " + pos.y.toFixed(2) + ")";
        $("#mousePos").text(str);
        
//         if ($("#enableTooltip:checked").length > 0) {
//             if (item) {
//                 var x = item.datapoint[0].toFixed(2),
//                     y = item.datapoint[1].toFixed(2);
// 
//                 $("#tooltip").html(item.series.label + " of " + x + " = " + y)
//                     .css({top: item.pageY+5, left: item.pageX+5})
//                     .fadeIn(200);
//             } else {
//                 $("#tooltip").hide();
//             }
//         }
    });

    $("#placeholder").bind("plotclick", function (event, pos, item) {
        var pt = [pos.x.toFixed(2), pos.y.toFixed(2)];

        if (currentPlotMode == PlotMode.SAMPLE) {
            newSamples.push(pt);
            plotSamples();
        } else if (currentPlotMode == PlotMode.CONSTRAINT) {
            var n = newConstraint.length;
            if(n < 2)
            {
                newConstraint.push(pt);
                plotSamples(fullCircle);
            }
            else
            {
                var t = sideOfLine(newConstraint[n-2], newConstraint[n-1], pt);
                // If it is on a line with the last points, just change line.
                if(t == 0) 
                {
                    newConstraint[n-1] = pt;
                    plotSamples();
                    return;
                }
                var fullCircle = false;
                // Check if the last point was already in the constraint set.
                for(i = 0; i < n; i++)
                {
                    if(newConstraint[i][0] == pos.x.toFixed(2) && newConstraint[i][1] == pos.y.toFixed(2))
                    {
                        newConstraint = newConstraint.slice(i);
                        n = newConstraint.length;
                        fullCircle = true;
                        break;
                    }
                }
                // Check convexity.    
                if(n > 2)
                {
                    var checkbound = n - 1
                    if(fullCircle)
                    {
                        checkbound = 1
                    }
                    
                    for(i = 0; i < checkbound; i++)
                    {
                        if(t != sideOfLine(newConstraint[n-2-i], newConstraint[n-1-i], p))
                        {
                            alert("Constrainted area should be convex");
                            return;
                        }
                    }
                }
                newConstraint.push(pt);
                plotSamples(fullCircle);
                
                if(fullCircle) 
                {
                    origin = [0,0];
                    for(i = 0; i < newConstraint.length - 1; i++)
                    {
                        if(newConstraint[i][1] == newConstraint[i+1][1]) 
                        {
                           
                        }
                        
                    }
                }
            }
            
        }
    });    

    $("#addSamples").change(function(e) {
        if ($(this).prop('checked')) {
            $("#addConstraint").prop('checked', false);
            currentPlotMode = PlotMode.SAMPLE;
        }
    });
    $("#addConstraint").change(function(e) {
        if ($(this).prop('checked')) {
            $("#addSamples").prop('checked', false);
            currentPlotMode = PlotMode.SAMPLE;
        }
    });

    // Handler for upload of PRISM
    $('#form-prism').submit(function(event){
        event.preventDefault();

        var formData = new FormData($(this)[0]);
        $.ajax({
            url: '../uploadPrism',
            type: 'POST',
            //Ajax events
            success: function() {
                getCurrentResult();
                listAvailableResults();
            },
            error: function() {alert('error');},
            // Form data
            data: formData,
            //Options to tell jQuery not to process data or worry about content-type.
            cache: false,
            contentType: false,
            processData: false
        });
    });

    // Handler for upload of result
    $('#form-result').submit(function(event){
        event.preventDefault();

        var formData = new FormData($(this)[0]);
        $.ajax({
            url: '../uploadResult',
            type: 'POST',
            //Ajax events
            success: function() {
                getCurrentResult();
                listAvailableResults();
            },
            error: function() {alert('error');},
            // Form data
            data: formData,
            //Options to tell jQuery not to process data or worry about content-type.
            cache: false,
            contentType: false,
            processData: false
        });
    });

    // Handler for changing active result
    $('form-select').submit(function(event) {
        result_name = $("#result-files").val();
        setCurrentResult(result_name);
        getCurrentResult();

        event.preventDefault();
    });
    
    // Handler for change of settings
    $("#thresholdSlider").on('change', function() {
        threshold = $('#thresholdSlider').val()/1000;
        $("#thresvalue").text(threshold);
        setThreshold(threshold);
        plotSamples();
    });
    
    // Show the empty graph immediately
    plotSamples();
    
    // Load initial settings
    getCurrentResult();
    listAvailableResults();
    getThreshold();
    getSamples();
});


</script>
</head>
 
<body>
<div id="header"><h1>Prophesy UI</h1><span id="busy-indicator">Working...</span></div>

<div id="plotsurround">
    <div id="placeholder"></div>
    <span id="mousePos">(0.00, 0.00)</span>
</div>

<div id="controlpanel">
    <div id="input">
        <h2>Input</h2>
        <ul class="tab-links">
            <li class="active" ><a href="#tab-prism">Upload Prism</a></li>
            <li><a href="#tab-upload">Upload result</a></li>
            <li><a href="#tab-select">Select result</a></li>
        </ul>
        <div class="tab-contents">
            <div id="tab-prism" class="tab active cp">
                <form id="form-prism">
                    <span>Path to prism file:</span><input type="file" name="file" />
                    <span>Path to PCTL file:</span><input type="file" name="pctl-file" />
                    <br>
                    <span>Run with:</span>
                    <select name="mctool">
                        <option selected="selected" value="pstorm">Prophesy</option>
                        <option value="param">param</option>
                        <!--<option>prism</option>-->
                    </select>
                    <br/>
                    <button id="upload-prism" type="submit" class="upload">Upload</button>
                </form>
            </div>
            
            <div id="tab-upload"  class="tab cp">
                <form id="form-result">
                    <span>Path to result file:</span><input type="file" name="file"/>
                    <br>
                    <select name="result-type">
                        <option value="pstorm" selected="selected">pstorm</option>
                        <option value="param">param</option>
                    </select>
                    <br/>
                    <button id="upload-result" type="submit" class="upload">Upload</button>
                </form>
            </div>
            
            <div id="tab-select" class="tab cp">
                <form id="form-select">
                    <select id="result-files">
                    </select>
                    <button id="select-result" type="submit" class="upload">Load</button>
                </form>
            </div>
        </div>
    </div> <!-- Input -->
    
    <div id="samples">
        <h2>Sampling</h2>
        <ul class="tab-links">
            <li class="active" ><a href="#tab-manual">Manual Sampling</a></li>
            <li><a href="#tab-auto">Auto Sampling</a></li>
        </ul>
        <div class="tab-contents">
            <div id="tab-manual" class="tab active cp">
                <div id="dNewSamplesContent">
                    <form id="form-samples-manual">
                    <label><input id="addSamples" type="radio" checked="checked">Add samples by mouse clicks</label>
                    <button id="submit-samples" type="submit" class="upload">Check New</button>
                    </form>
                </div>
            </div>
            <div id="tab-auto" class="tab cp">
                <form id="form-samples-auto">
                    <label>Number of iterations:<input id="iterations" type="text" value="2"/></label>
                    <br/>
                    <label>Sampling number:<input id="sampling" type="text" value="2"/></label>
                    <button id="generate-samples" type="submit" class="upload">Go</button>
                </form>
            </div>
        </div>
    </div> <!-- Samples -->
    
    
    <div id="constraints">
        <h2>Constraints</h2>
        <ul class="tab-links">
            <li class="active" ><a href="#tab-constr-manual">Manual Constraints</a></li>
            <li><a href="#tab-constr-auto">Auto Constraints</a></li>
        </ul>
        <div class="tab-contents">
            <div id="tab-constr-manual" class="tab active cp">
                <div id="dNewSamplesContent">
                    <form id="form-constraints-manual"><label>
                    <input id="addConstraint" type="radio">Add constraints by mouse clicks</label>
                    <button id="manualConstraints" class="submit">Check New</button>
                    </form>
                </div>
            </div>
            <div id="tab-constr-auto" class="tab cp">
                <form id="form-constraints-auto">
                    
                </form>
            </div>
        </div>
    </div> <!-- Constraints -->
    
    <div id="settings">
        <h2>Settings</h2>
        <span>Threshold:</span>
        <input type="range" min="0" max="1000" value="500" id="thresholdSlider" /><span id="thresvalue">0.50</span>
        <br>
        <span>SMT Solver:</span>
        <select id="smtsolver"><option selected="selected">SMT-RAT</option><option>Z3</option></select>
    </div>
</div> <!-- Control panel -->

<div id="infopanel">
    <h2>Info</h2>
    <h3>Rational Function</h3>
    <div id="info_ratfunc">Not loaded</div>
</div>

</body>
  
</html>